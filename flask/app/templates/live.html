{% extends "base.html" %} <!--this means that you are extending the base tempate -->
{% block title %}Live Trends{% endblock %}
{% block nav_active_live %}active{% endblock %}
{% block head %}
<script type="text/javascript">
  var rtLocURL = "/api/loc/"
  var country = '';
  var city = '';
 {% if country %}
  country =  {{ country|safe }};
 {% endif %}
 {% if city %}
  city =  {{ city|safe }};
 {% endif %}
</script>
{% endblock %}
{% block map %} 
 <div id="map"></div>
 <script type="text/javascript">
  var image = '../static/images/green_dot.png'
  var locAPI = '/api/loc/'
  var map;
  function initMap() {
    map = new google.maps.Map(document.getElementById('map'), {
      center: {lat: 30.176095, lng: -6.488868},
      zoom: 2
    });

  var greenMarker = new google.maps.Marker({
    position: {lat: -33.890, lng: 151.274},
    map: map,
    icon: image
   });
  }
 </script> 
{% endblock %}
{% block location %} 
        <div class="row" style="height:10vh;">
                <div class="col-md-4 col-md-offset-4 daily_form_div" style="margin-top:1vh;">
                        <form action="live" method="POST">
                                <div class="form-group text-center">
                                        <label style="font-weight:300; font-size:24px;">Geo-Location:</label>
                                        <input type="text" class="form-control" id="country" name="country" placeholder="US">
                                        <input type="text" class="form-control" id="city" name="city" placeholder="New York">

                                        <button type="submit" value="Send" name="daily-container" class="btn btn-default id-submit">Topics</button>
                                </div>
                        </form>
                </div>
        </div>

{% endblock %}

{% block trend %}
 {% if output %}
<div class="container">
      <div class="starter-template">
        <div class="row" style="height:100vh;">
                <div class="col-md-10 col-md-offset-1 trend-results">
		<h2>Number of trends: {{totalTrends}}{% if totalTweets and totalTweets>0 %} Total tweets: {{totalTweets}}{% endif %}</h2>
                    <table class="table">
                      <thead>
                        <tr>
                          {% if fields>=1 %}<th>country</th>{% endif %}
                          {% if fields==2 %}<th>city</th>{% endif %}
                          <th>topic</th>
                          <th>count</th>
                        </tr>
                      </thead>
                      <tbody>
			{% set sort_on = request.args.sort_on|default('count') %}
                        {% for val in output|sort(attribute=sort_on, reverse=True) %}
                        <tr>
                          {% if fields>=1 %}<td>{{val.country}}</td>{% endif %}
                          {% if fields==2 %}<td>{{val.city}}</td>{% endif %}
                          <td>{{val.topic|e}}</td>
                          <td>{{val.count}}</td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                </div>
        </div>
      </div>

    </div>

 {% endif %}
{% endblock %}

{% block tail %}
<script>
var t_int = 1000;
var addTweets = setInterval(liveItems, t_int);
var addIter = 0;
var ttAPI = "/api/rt/";
var markers = [];

function liveTweets() {
  $.getJSON( ttAPI )
    .done(function( data ) {
      $.each( data.tweets, function( i, item ) {
      //$.each( data.country_day_trends, function( i, item ) {
        //tweet_html = '<div class="tweet animated fadeInDown">by: ' + item.user + ' at: ' + item.time_ms + ' tag: <b>' + item.topic + '</b><br/>' + item.tweet + '</div>';
        var d = new Date(item.time_ms);
          tweet_html = '<div class="tweet">by: ' + item.user + ' at: ' + d.toString() + ' tag: <b>' + item.topic + '</b><br/>' + item.tweet + '</div>';
       //   tweet_html = '<p>by : ' + item.count + ' at : ' + item.topic + '<br/>' + item.dayslot + '</p>';
	  if (addIter == 9){
	    $('#live_tweets').empty();
	    addIter = 0;
	  }
          $('#live_tweets').prepend(tweet_html);
	  addIter += 1;
//	  console.log(tweet_html)
        })
    });
}

// Sets the map on all markers in the array.
function setMapOnAll(map) {
  for (var i = 0; i < markers.length; i++) {
    markers[i].setMap(map);
  }
}
// Deletes all markers in the array by removing references to them.
function deleteMarkers() {
  setMapOnAll(null);  
  markers = [];
}
// Adds a marker to the map and push to the array.
function addMarker(location) {
  var marker = new google.maps.Marker({
    position: location,
    map: map
  });
  markers.push(marker);
}

function liveLocations() {
  deleteMarkers()
  $.getJSON( locAPI )
    .done(function( data ) {
      $.each( data.tweet_locations, function( i, item ) {
	var loc = {lat: item.latitude, lng: item.longitude};
	addMarker(loc)
      })
    });
}

function liveItems() {
 liveLocations();
 liveTweets();
}

liveItems();

</script>

<script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDElSPIgRjb-T5Ma0PdHR2HmJzX2l0yHOs&callback=initMap">
</script>

<script>
</script>
{% endblock %}
